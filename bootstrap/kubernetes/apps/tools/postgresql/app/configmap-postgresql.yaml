---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-values
  namespace: tools
data:
  values.yaml: |-
    global:
      postgresql:
        auth:
          existingSecret: "secret-postgresql"
          secretKeys:
            adminPasswordKey: password

    image:
      registry: docker.io
      repository: bitnami/postgresql
      tag: "latest"
      digest: ""
      debug: true

    auth:
      enablePostgresUser: true
      existingSecret: "secret-postgresql"
      secretKeys:
        adminPasswordKey: password
      usePasswordFiles: false

    primary:
      extraEnvVars:
        - name: PGDATA
          value: /var/lib/postgresql/data
        - name: AUTHENTIK_PASSWORD
          valueFrom:
            secretKeyRef:
              name: secret-postgresql
              key: authentik-password
      containerSecurityContext:
        enabled: true
        seLinuxOptions: {}
        runAsUser: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        privileged: false
        readOnlyRootFilesystem: false
        allowPrivilegeEscalation: false
        capabilities:
          drop: ["ALL"]
        seccompProfile:
          type: "RuntimeDefault"
      initdb:
        scriptsSecret: secret-postgresql
      pgHbaConfiguration: |-
        local   all             all                                     trust
        host    all             all             127.0.0.1/32            trust
        host    all             all             ::1/128                 trust
        host    all             all             0.0.0.0/0               md5
      postgresqlConfiguration: |-
        listen_addresses = '*'
      podSecurityContext:
        enabled: true
        fsGroupChangePolicy: Always
        sysctls: []
        supplementalGroups: []
        fsGroup: 1000
        
      service:
        type: LoadBalancer
        ports:
          postgresql: 5432
        loadBalancerIP: 10.42.20.70
      
      persistence:
        enabled: true
        storageClass: nfs-client
        accessModes:
          - ReadWriteOnce
        size: 8Gi
        mountPath: /var/lib/postgresql
      extraVolumes:
        - name: run-postgresql
          emptyDir: {}
      extraVolumeMounts:
        - name: run-postgresql
          mountPath: /var/run/postgresql
        - name: postgresql-config
          mountPath: /var/lib/postgresql/data/postgresql.conf
          subPath: postgresql.conf
        - name: postgresql-config
          mountPath: /var/lib/postgresql/data/pg_hba.conf
          subPath: pg_hba.conf
