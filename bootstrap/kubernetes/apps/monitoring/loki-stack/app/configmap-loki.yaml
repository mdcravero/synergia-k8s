apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-stack-values
  namespace: monitoring
data:
  values.yaml: |-
    loki:
      enabled: true
      isDefault: true
      env: 
        PUID: 1000
        PGID: 1000
        TZ: "America/Argentina/Cordoba"
      config:
        auth_enabled: false
        server:
          log_level: info
        schema_config:
          configs:
            - from: 2023-01-01
              store: boltdb-shipper
              object_store: filesystem
              schema: v11
              index:
                prefix: index_
                period: 24h
        storage_config:
          boltdb_shipper:
            active_index_directory: /var/loki/index
            cache_location: /var/loki/cache
          filesystem:
            directory: /var/loki/chunks
      persistence:
        enabled: true
        storageClassName: "nfs-client"
        accessModes:
          - ReadWriteMany
        size: 10Gi

    promtail:
      enabled: true
      config:
        clients:
          - url: http://loki:3100/loki/api/v1/push
        positions:
          filename: /var/log/positions.yaml
        scrape_configs:
          - job_name: system
            static_configs:
              - targets:
                  - localhost
                labels:
                  job: varlogs
                  __path__: /var/log/**/*.log
          - job_name: kubernetes-pods
            kubernetes_sd_configs:
              - role: pod
            relabel_configs:
              - source_labels: [__meta_kubernetes_pod_node_name]
                action: replace
                target_label: __host__
              - source_labels: [__meta_kubernetes_pod_container_name]
                action: replace
                target_label: container
              - source_labels: [__meta_kubernetes_pod_name]
                action: replace
                target_label: pod
              - source_labels: [__meta_kubernetes_namespace]
                action: replace
                target_label: namespace
              - source_labels: [__meta_kubernetes_pod_label_app]
                action: replace
                target_label: app
              - source_labels: [__meta_kubernetes_pod_label_name]
                action: replace
                target_label: name
              - action: replace
                replacement: /var/log/pods/*/*/*.log
                target_label: __path__

    grafana:
      enabled: false
