apiVersion: v1
kind: ConfigMap
metadata:
  name: parca-values
  namespace: monitoring
data:
  values.yaml: |-
    parca:
      persistentVolume:
        enabled: true
        storageClass: "nfs-client"
        accessModes:
          - ReadWriteOnce
        size: 10Gi

    ingress:
      enabled: true
      className: traefik
      hosts:
        - host: parca.synergia.net.ar
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: parca-tls
          hosts:
            - parca.synergia.net.ar
      annotations:
        traefik.ingress.kubernetes.io/router.entrypoints: websecure
        traefik.ingress.kubernetes.io/router.tls: "true"
        traefik.ingress.kubernetes.io/router.tls.certresolver: le

    # Enable Parca Agent for automatic profiling
    parca-agent:
      enabled: true
      config:
        # Scrape all pods in the cluster
        scrape_configs:
          - job_name: 'kubernetes-pods'
            kubernetes_sd_configs:
              - role: pod
            relabel_configs:
              - source_labels: [__meta_kubernetes_pod_annotation_parca_dev_scrape]
                action: keep
                regex: true
              - source_labels: [__meta_kubernetes_pod_annotation_parca_dev_path]
                action: replace
                target_label: __metrics_path__
                regex: (.+)
              - source_labels: [__meta_kubernetes_pod_annotation_parca_dev_port]
                action: replace
                regex: (\d+)
                target_label: __address__
                replacement: $1
              - action: labelmap
                regex: __meta_kubernetes_pod_label_(.+)
              - source_labels: [__meta_kubernetes_namespace]
                action: replace
                target_label: namespace
              - source_labels: [__meta_kubernetes_pod_name]
                action: replace
                target_label: pod